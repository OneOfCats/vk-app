<!DOCTYPE HTML>
<html ng-app="friendsSearchApp">
	<head>
		<!-- Custom scrollbars -->
		<link rel="stylesheet" href="bower_components/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.min.css" type="text/css"/>
		<script src="bower_components/jquery/dist/jquery.min.js"></script>
	  	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.0/angular.js"></script>
		<script src="bower_components/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js"></script>
		<script src="bower_components/ng-scrollbars/dist/scrollbars.min.js"></script>
		<!-- /Custom scrollbars -->
	  <meta charset="utf-8">
	  <title>Find your friend</title>
	  <script src="app.js"></script>
	  <script src="components/customSelect/customSelect.js"></script>
	  <script src="components/vkDataExchange/vkDataExchange.js"></script>
	  <link rel="stylesheet" type="text/css" href="style.css">
	</head>

	<body>
	  <div ng-controller="friendsAppCtrl as ctrl" class="wrapper">
		<div class="window no_border" ng-class="{no_border: ctrl.userPublics.length==0}">
			<div class="header">
				<div class="item bordered">
					Ваш id
					<input type="text" ng-model="ctrl.userVkId" ng-change="ctrl.findUserPublics()">
				</div>
				<div class="container" ng-class="{collapsedFast: ctrl.commonSubscribers.length!=0}">
					<div ng-repeat="public in ctrl.publicsForSearch track by $index" class="item full" ng-class="{hidden: ctrl.nowDownloading!=$index}">
			  			{{public.name}}
				  		<div class="loading-wrapper">
				  			<div ng-show="public.subscribers" class="loading" style="width:{{(public.subscribers.loaded / public.subscribers.total)*99}}%"></div>
			  			</div>
			  		</div>
				</div>
				<div class="container collapsed" ng-class="{collapsed: ctrl.commonSubscribers.length==0}">
					<div class="item">
						Страна
						<custom-select from="ctrl.countriesList" to="ctrl.country"></custom-select>
					</div>
					<div class="item" ng-class="{collapsed: ctrl.country.title=='Любая страна'}">
						Город
						<custom-select from="ctrl.citiesList" to="ctrl.city" depends-on="ctrl.cityInput"></custom-select>
						<input type="text" ng-model="ctrl.cityInput" ng-change="ctrl.getCities(ctrl.cityInput)" class="helper" select-on-click>
					</div>
					<div class="item last small">
						Пол
						<custom-select from="ctrl.genders" to="ctrl.selectedGender"></custom-select>
					</div>
				</div>
			</div>
			<div class="main collapsed" ng-class="{collapsed: ctrl.userPublics.length==0}">
				<div class="right list">
					<div class="content checkboxes" ng-scrollbars ng-scrollbars-config="ctrl.scrollbarsConfig">
						<label class="item" ng-repeat="public in ctrl.userPublics">
							<img src="{{public.photo_50}}" alt="">
							<input type="checkbox" ng-click="ctrl.addSelectedPublic($index)">
							<div>
								{{public.name}}
								<span>{{public.dbSubscribers.items.length}}</span>
							</div>
						</label>
					</div>
					<div class="additional">
						<a class="uncheck" ng-click="ctrl.uncheckAll()"></a>
						<button ng-click="ctrl.findSubscribers()" ng-disabled="ctrl.publicsForSearch.length < 2">Bro`search!</button>
					</div>
				</div>
				<div class="left plate collapsed" ng-class="{collapsed: ctrl.commonSubscribers.length==0}">
					<div class="content" ng-scrollbars ng-scrollbars-config="ctrl.scrollbarsConfig">
						<a class="item" ng-repeat="subscriber in ctrl.commonSubscribers | locationFilter:ctrl.country.id:ctrl.city.id:ctrl.sex as filtered track by $index" href="http://vk.com/id{{subscriber.id}}">
							<img ng-src="{{subscriber.photo_100}}" alt="">
							<div>
								{{subscriber.first_name}} {{subscriber.last_name}}
							</div>
						</a>
						<a class="item unknown" ng-repeat="subscriber in ctrl.commonSubscribers | undefinedPlaceFilter:ctrl.sex track by $index" href="http://vk.com/id{{subscriber.id}}">
							<img src="{{subscriber.photo_100}}" alt="">
							<div>
								{{subscriber.first_name}} {{subscriber.last_name}}
							</div>
						</a>
					</div>
					<div class="additional">
						<span>
							Найдено: {{filtered.length}}
						</span>
					</div>
				</div>
			</div>
		</div>
		
		<div id="debug">
			<div>
		  		Debug:
		  		{{ctrl.country.title}}
		  	</div>

		  	<div>
		  		Ваш vk id:
		  		<input type="text" ng-model="ctrl.userVkId" ng-change="ctrl.findUserPublics()">
		  	</div>
		  	
			<div>
				Выберите паблики:
			  	<div ng-repeat="public in ctrl.userPublics">
			  		<input type="checkbox" ng-click="ctrl.addSelectedPublic($index)"> {{public.name}} {{public.dbSubscribers.items.length}}
			  	</div>
			</div>
		  	
			<div>
				Выбранные паблики:
			  	<ul>
			  		<li ng-repeat="public in ctrl.publicsForSearch">
			  			{{public.name}}
			  			<div ng-show="public.subscribers">
			  				{{public.subscribers.loaded}} / {{public.subscribers.total}}. 
			  			</div>
			  			<div ng-show="public.updated > 0">
			  				<input type="checkbox" ng-model="public.getFromDb"> Взять подписчиков из базы (быстрее). Последнее обновление базы: {{public.updated | date : "d/M/yy H:mm"}}
			  			</div>
			  		</li>
			  	</ul>
			</div>

			<div>
				<button ng-click="ctrl.findSubscribers()">Найти подписчиков</button>
			</div>
			
			<custom-select from="ctrl.countriesList" to="ctrl.country"></custom-select>
			<input type="text" ng-model="ctrl.cityInput" ng-change="ctrl.getCities(ctrl.cityInput)">
			<custom-select from="ctrl.citiesList" to="ctrl.city"></custom-select>
			Пол:
			<label><input type="radio" ng-model="ctrl.sex" ng-value="1">Женский</label>
			<label><input type="radio" ng-model="ctrl.sex" ng-value="2">Мужской</label>
			<label><input type="radio" ng-model="ctrl.sex" ng-value="0">Любой</label>

			<div ng-show="ctrl.commonSubscribers.length != 0">
				Найденные общие подписчики:
				<div>
					<ul>
						<li ng-repeat="subscriber in ctrl.commonSubscribers | locationFilter:ctrl.country.id:ctrl.city.id:ctrl.sex track by $index">
							<a href="http://vk.com/id{{subscriber.id}}">{{subscriber.first_name}} {{subscriber.last_name}}</a><span ng-show="subscriber.undefinedPlace">Местоположение неизвестно</span>
						</li>
					</ul>
				</div>
				Пользователи с неизвестным точным расположением:
				<div>
					<ul>
						<li ng-repeat="subscriber in ctrl.commonSubscribers | undefinedPlaceFilter:ctrl.sex track by $index">
							<a href="http://vk.com/id{{subscriber.id}}">{{subscriber.first_name}} {{subscriber.last_name}}</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	  </div>

	  <script src="//vk.com/js/api/openapi.js" type="text/javascript"></script>
	  <script type="text/javascript">
	    VK.init({
	      apiId: 5225238
	    });
	  </script>
	</body>
</html>